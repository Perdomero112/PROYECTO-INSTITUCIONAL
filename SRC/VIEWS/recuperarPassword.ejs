<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recuperar Contraseña - Biblioteca BG</title>
    <link rel="stylesheet" href="/CSS/recuperarPassword.style.css">
    <link rel="icon" href="/upload/icon-bg.png" type="imagen/png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="recuperar-container">
        <!-- Logo -->
        <div class="logo">
            <img src="/upload/icon-bg.png" alt="Logo Biblioteca BG">
        </div>
        
        <!-- Panel izquierdo - Branding -->
        <div class="branding-panel">
            <div class="branding-content">
                <h1>BIBLIOTECA BG</h1>
                <p class="subtitle">Centro que brilla irradiando cultura</p>
                <p class="description">No te preocupes, recuperar tu acceso es fácil. Sigue los pasos para restablecer tu contraseña y volver a acceder a todos nuestros recursos académicos.</p>
                <a href="/login" class="signin-link">¿Recordaste tu contraseña? Inicia Sesión</a>
            </div>
        </div>
        
        <!-- Panel derecho - Formulario -->
        <div class="form-panel">
            <h2>Recuperar Contraseña</h2>
            
            <!-- Indicador de progreso -->
            <div class="progress-indicator">
                <div class="progress-step active" data-step="1">1</div>
                <div class="progress-step" data-step="2">2</div>
                <div class="progress-step" data-step="3">3</div>
            </div>
        
            <!-- Formulario 1: Validar Email -->
            <form id="formEmail" class="form-step active">
                <h3>Paso 1: Ingresa tu correo electrónico</h3>
                <p>Te enviaremos un código de verificación a tu correo para confirmar tu identidad.</p>
                <div class="form-group">
                    <label for="email">Correo Electrónico</label>
                    <input type="email" name="email" id="email" required placeholder="Ingresa tu correo electrónico">
                </div>
                <button type="submit" class="submit-btn">Enviar Código →</button>
            </form>

            <!-- Formulario 2: Validar Código -->
            <form id="formCodigo" class="form-step">
                <h3>Paso 2: Verifica tu identidad</h3>
                <p>Hemos enviado un código de 6 dígitos a tu correo electrónico. Ingresa el código para continuar.</p>
                
                <div class="code-input">
                    <input type="text" class="code-digit" maxlength="1" data-index="0" required>
                    <input type="text" class="code-digit" maxlength="1" data-index="1" required>
                    <input type="text" class="code-digit" maxlength="1" data-index="2" required>
                    <input type="text" class="code-digit" maxlength="1" data-index="3" required>
                    <input type="text" class="code-digit" maxlength="1" data-index="4" required>
                    <input type="text" class="code-digit" maxlength="1" data-index="5" required>
                </div>
                
                <div class="timer" id="timer">Reenviar código en <span id="countdown">60</span>s</div>
                <button type="button" class="resend-btn" id="resendBtn" disabled>Reenviar código</button>
                
                <input type="hidden" name="email" id="emailHidden">
                <button type="submit" class="submit-btn">Verificar Código →</button>
            </form>

            <!-- Formulario 3: Cambiar Contraseña -->
            <form id="formPassword" class="form-step">
                <h3>Paso 3: Crea tu nueva contraseña</h3>
                <p>Ingresa una nueva contraseña segura para tu cuenta. Asegúrate de que sea fácil de recordar pero difícil de adivinar.</p>
                
                <div class="form-group">
                    <label for="nuevaPassword">Nueva Contraseña</label>
                    <input type="password" name="nuevaPassword" id="nuevaPassword" required placeholder="Crea una contraseña segura">
                </div>
                
                <div class="form-group">
                    <label for="confirmarPassword">Confirmar Contraseña</label>
                    <input type="password" name="confirmarPassword" id="confirmarPassword" required placeholder="Confirma tu nueva contraseña">
                </div>
                
                <input type="hidden" name="email" id="emailHidden2">
                <button type="submit" class="submit-btn">Cambiar Contraseña →</button>
            </form>

            <!-- Contenedor para mensajes -->
            <div id="messageContainer" class="message-container"></div>
            
            <div class="links">
                <a href="/login">¿Recordaste tu contraseña? Inicia Sesión</a>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentStep = 1;
        let countdownTimer;
        let timeLeft = 60;

        // Elementos del DOM
        const forms = document.querySelectorAll('.form-step');
        const progressSteps = document.querySelectorAll('.progress-step');
        const messageContainer = document.getElementById('messageContainer');
        const codeInputs = document.querySelectorAll('.code-digit');
        const timer = document.getElementById('timer');
        const resendBtn = document.getElementById('resendBtn');
        const countdownSpan = document.getElementById('countdown');

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            initializeCodeInputs();
            setupFormHandlers();
        });

        // Configurar inputs de código
        function initializeCodeInputs() {
            codeInputs.forEach((input, index) => {
                input.addEventListener('input', function(e) {
                    const value = e.target.value;
                    if (value.length === 1) {
                        // Mover al siguiente input
                        if (index < codeInputs.length - 1) {
                            codeInputs[index + 1].focus();
                        }
                        input.classList.add('filled');
                    } else {
                        input.classList.remove('filled');
                    }
                });

                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Backspace' && e.target.value === '') {
                        // Mover al input anterior
                        if (index > 0) {
                            codeInputs[index - 1].focus();
                        }
                    }
                });
            });
        }

        // Configurar manejadores de formularios
        function setupFormHandlers() {
            // Utilidad para POST x-www-form-urlencoded
            async function postForm(url, data) {
                const body = new URLSearchParams(data).toString();
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body
                });
                const text = await res.text();
                return { ok: res.ok, status: res.status, text };
            }

            // Formulario 1: Email -> POST /validarEmail
            document.getElementById('formEmail').addEventListener('submit', async function(e) {
                e.preventDefault();
                clearMessages();
                const email = document.getElementById('email').value.trim();
                if (!email) {
                    showMessage('Ingresa un correo válido', 'error');
                    return;
                }
                try {
                    const { ok, text } = await postForm('/validarEmail', { email });
                    if (ok) {
                        showMessage('Código enviado a tu correo electrónico', 'success');
                        // Propagar email a los siguientes pasos
                        document.getElementById('emailHidden').value = email;
                        document.getElementById('emailHidden2').value = email;
                        // Reset inputs de código
                        codeInputs.forEach(i => i.value = '');
                        startCountdown();
                        nextStep();
                    } else {
                        showMessage(text || 'No se pudo enviar el código. Intenta nuevamente.', 'error');
                    }
                } catch (err) {
                    showMessage('Error de red al enviar el código', 'error');
                }
            });

            // Formulario 2: Código -> POST /validarPassword
            document.getElementById('formCodigo').addEventListener('submit', async function(e) {
                e.preventDefault();
                clearMessages();
                const email = document.getElementById('emailHidden').value;
                const code = Array.from(codeInputs).map(input => input.value).join('');
                if (code.length !== 6) {
                    showMessage('Por favor ingresa el código completo', 'error');
                    return;
                }
                try {
                    const { ok, text } = await postForm('/validarPassword', { cod: code, email });
                    if (ok) {
                        showMessage('Código verificado correctamente', 'success');
                        nextStep();
                    } else {
                        showMessage(text || 'Código incorrecto o expirado', 'error');
                    }
                } catch (err) {
                    showMessage('Error de red al verificar el código', 'error');
                }
            });

            // Formulario 3: Nueva contraseña -> POST /cambiarPassword
            document.getElementById('formPassword').addEventListener('submit', async function(e) {
                e.preventDefault();
                clearMessages();
                const password = document.getElementById('nuevaPassword').value;
                const confirmPassword = document.getElementById('confirmarPassword').value;
                const email = document.getElementById('emailHidden2').value;
                
                if (password !== confirmPassword) {
                    showMessage('Las contraseñas no coinciden', 'error');
                    return;
                }
                if (password.length < 6) {
                    showMessage('La contraseña debe tener al menos 6 caracteres', 'error');
                    return;
                }
                try {
                    const { ok, text } = await postForm('/cambiarPassword', { nuevaPassword: password, email });
                    if (ok) {
                        showMessage('Contraseña cambiada exitosamente', 'success');
                        setTimeout(() => { window.location.href = '/login'; }, 1500);
                    } else {
                        showMessage(text || 'No se pudo cambiar la contraseña', 'error');
                    }
                } catch (err) {
                    showMessage('Error de red al cambiar la contraseña', 'error');
                }
            });

            // Botón de reenvío -> re-POST /validarEmail
            resendBtn.addEventListener('click', async function() {
                clearMessages();
                const email = document.getElementById('emailHidden').value;
                if (!email) {
                    showMessage('No hay un correo para reenviar el código', 'error');
                    return;
                }
                try {
                    const { ok, text } = await postForm('/validarEmail', { email });
                    if (ok) {
                        showMessage('Código reenviado', 'info');
                        startCountdown();
                    } else {
                        showMessage(text || 'No se pudo reenviar el código', 'error');
                    }
                } catch (err) {
                    showMessage('Error de red al reenviar el código', 'error');
                }
            });
        }

        // Avanzar al siguiente paso
        function nextStep() {
            if (currentStep < 3) {
                // Ocultar paso actual
                forms[currentStep - 1].classList.remove('active');
                progressSteps[currentStep - 1].classList.remove('active');
                progressSteps[currentStep - 1].classList.add('completed');
                
                // Mostrar siguiente paso
                currentStep++;
                forms[currentStep - 1].classList.add('active');
                progressSteps[currentStep - 1].classList.add('active');
                
                // Limpiar mensajes
                clearMessages();
            }
        }

        // Mostrar mensajes
        function showMessage(text, type) {
            clearMessages();
            const message = document.createElement('div');
            message.className = `message message-${type}`;
            message.textContent = text;
            messageContainer.appendChild(message);
        }

        // Limpiar mensajes
        function clearMessages() {
            messageContainer.innerHTML = '';
        }

        // Contador de tiempo
        function startCountdown() {
            if (countdownTimer) clearInterval(countdownTimer);
            timeLeft = 60;
            resendBtn.disabled = true;
            timer.innerHTML = 'Reenviar código en <span id="countdown">60</span>s';
            const newSpan = document.getElementById('countdown');
            countdownTimer = setInterval(() => {
                timeLeft--;
                newSpan.textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(countdownTimer);
                    resendBtn.disabled = false;
                    timer.innerHTML = '¿No recibiste el código?';
                }
            }, 1000);
        }

        // Animación de entrada
        window.addEventListener('load', function() {
            document.querySelector('.recuperar-container').style.opacity = '0';
            document.querySelector('.recuperar-container').style.transform = 'translateY(30px)';
            
            setTimeout(() => {
                document.querySelector('.recuperar-container').style.transition = 'all 0.6s ease';
                document.querySelector('.recuperar-container').style.opacity = '1';
                document.querySelector('.recuperar-container').style.transform = 'translateY(0)';
            }, 100);
        });
    </script>
</body>
</html>